import os
from hasher import sha256sum, md5sum
from tqdm import tqdm

SEARCH_DIRECTORY = "/home/dave"

with open("main.hdb") as f:
    data = f.readlines()

sig_dict = {} #hash mapped to file name
for row in data:
    hash, id, virus_name = row.split(":")
    sig_dict[hash] = virus_name

files_to_hash = []

for root, dirs, files in os.walk(SEARCH_DIRECTORY):
    for f in files:
        full_path = root + "/" + f
        files_to_hash.append(full_path)

count = 0
for file in tqdm(files_to_hash):
    md5 = md5sum(file)
    sha256 = sha256sum(file)
    is_md5_match = md5 in sig_dict
    is_sha256_match = sha256 in sig_dict
    if is_sha256_match:
        print(f"The file is a virus: {file}.")
        print(f"The file matches virus name: {sig_dict[sha256]}.")
        count += 1
    if is_md5_match:
        print(f"The file is a virus: {file}.")
        print(f"The file matches virus name: {sig_dict[md5]}.")
        count += 1

if count == 0:
    print("No viruses were found.")
print(f"The number of files scanned were {len(files_to_hash)}.")
print(f"The number of virus signatures in the database is {len(sig_dict)}.")
